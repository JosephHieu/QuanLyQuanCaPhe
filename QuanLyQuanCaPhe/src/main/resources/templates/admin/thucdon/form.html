<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thêm Danh mục món</title>
    <link rel="stylesheet" th:href="@{/css/layout.css}" />
    <link rel="stylesheet" th:href="@{/css/menu.css}" />

</head>
<body>
<div th:insert="~{fragments/header :: header}"></div>
<div class="page-container">
    <div class="sidebar-wrapper">
        <div th:insert="~{fragments/sidebar :: sidebar}"></div>
        <div th:insert="~{fragments/footer :: footer}"></div>
    </div>
    <main class="main-content">
        <div class="breadcrumb">Thêm danh mục món</div>

<form th:action="@{/admin/thucdon/save}" th:object="${thucDonForm}" method="post">
    <div th:if="${errorMessage}" class="global-error-message">
        <strong th:text="${errorMessage}"></strong>
    </div>

    <div class="form-grid">
        <label for="tenMon">Tên món:</label>
        <input type="text" id="tenMon" th:field="*{tenMon}" required />

        <label for="giaTien">Giá tiền:</label>
        <input type="number" id="giaTien" th:field="*{giaTien}" min="0" step="1000" required />

        <label for="loaiMon">Loại món:</label>
        <input type="text" id="loaiMon" th:field="*{loaiMon}" required placeholder="Ví dụ: Cafe, Trà, Nước ép..." />
    </div>

    <div class="ingredients-section">
        <h4>Thành phần:</h4>
        <table class="ingredients-table">
            <thead>
            <tr>
                <th>Tên thành phần (Nguyên liệu)</th>
                <th>Khối lượng</th>
                <th>Đơn vị tính</th>
                <th class="action-col">Xóa</th>
            </tr>
            </thead>
            <tbody id="ingredient-tbody">
            </tbody>
        </table>
        <button type="button" class="add-row-btn" onclick="addIngredientRow()">+ Thêm thành phần</button>
    </div>

    <div class="form-actions">
        <button type="submit">Thêm món</button>
        <a th:href="@{/admin/thucdon}">Hủy</a>
    </div>
</form>

<table style="display: none;">
    <tbody id="ingredient-row-template">
    <tr>
        <td>
            <select name="thanhPhan[__index__].maHangHoa" class="ingredient-select" onchange="updateUnit(this)" required>
                <option value="">-- Chọn nguyên liệu --</option>
                <option th:each="nl : ${dsNguyenLieu}"
                        th:value="${nl.maHangHoa}"
                        th:text="${nl.tenHangHoa}"
                        th:data-unit="${nl.donViTinh?.tenDonVi}">
                </option>
            </select>
        </td>
        <td>
            <input type="number" name="thanhPhan[__index__].khoiLuong" min="0" step="any" required />
        </td>
        <td>
            <span class="unit-display">(chọn nguyên liệu)</span>
        </td>
        <td class="action-col">
            <span class="delete-row-btn" onclick="removeIngredientRow(this)">X</span>
        </td>
    </tr>
    </tbody>
</table>

</main>
</div>

<script>
    let ingredientIndex = 0; // Biến đếm index cho mảng thanhPhan

    function addIngredientRow() {
        const tableBody = document.getElementById('ingredient-tbody');
        // Lấy template HTML
        const template = document.getElementById('ingredient-row-template').innerHTML;
        // Thay thế placeholder __index__ bằng giá trị index hiện tại
        const newRowHtml = template.replace(/__index__/g, ingredientIndex);

        // Thêm dòng mới vào bảng
        const newRow = tableBody.insertRow();
        newRow.innerHTML = newRowHtml;

        ingredientIndex++; // Tăng index cho lần thêm tiếp theo
    }

    function removeIngredientRow(button) {
        // Lấy thẻ <tr> cha và xóa nó
        const row = button.closest('tr');
        row.remove();
        // (Lưu ý: Việc này không cập nhật lại index của các dòng còn lại,
        // nhưng Spring Boot vẫn xử lý được)
    }

    function updateUnit(selectElement) {
        // Lấy đơn vị tính từ data-unit
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const unit = selectedOption.getAttribute('data-unit');
        // Tìm span hiển thị đơn vị trong cùng hàng <tr>
        const row = selectElement.closest('tr');
        const unitDisplay = row.querySelector('.unit-display');
        if (unit) {
            unitDisplay.textContent = unit;
        } else {
            unitDisplay.textContent = '(chọn nguyên liệu)';
        }
    }

    // Tự động thêm 1 dòng trống khi tải trang
    document.addEventListener('DOMContentLoaded', function() {
        addIngredientRow();
    });
</script>
</body>
</html>