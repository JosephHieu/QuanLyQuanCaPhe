<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Bán hàng</title>
    <link rel="stylesheet" th:href="@{/css/layout.css}" />
    <link rel="stylesheet" th:href="@{/css/sales.css}" />

    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>

</head>
<body>
<div th:insert="~{fragments/header :: header}"></div>

<div class="page-container">
    <div class="sidebar-wrapper">
        <div th:insert="~{fragments/sidebar :: sidebar}"></div>
        <div th:insert="~{fragments/footer :: footer}"></div>
    </div>

    <main class="main-content">
        <div class="breadcrumb">Quản lý bán hàng</div>

        <div class="table-grid" id="tableGrid">
            <div th:each="ban : ${dsBan}"
                 th:classappend="'table-item status-' + ${ban.tinhTrang == 'Trống' ? 'trong' : (ban.tinhTrang == 'Có khách' ? 'cokhach' : (ban.tinhTrang == 'Đặt trước' ? 'dattruoc' : 'unknown'))}"
                 th:attr="data-maban=${ban.maBan}, data-tenban=${ban.tenBan}"
                 onclick="selectTable(this)">

                <span th:text="${ban.tenBan}">Bàn 01</span>
                <small th:if="${ban.tinhTrang != 'Trống'}" th:text="'&lt;' + ${ban.tinhTrang} + '&gt;'">Trạng thái</small>
            </div>
        </div>

        <div class="action-buttons">
            <button onclick="viewTable()">Xem bàn</button>
            <button onclick="openMoveTableModal()">Chuyển bàn</button>
            <button onclick="splitTable()">Tách bàn</button>
            <button onclick="openMergeTableModal()">Gộp bàn</button>
            <button onclick="cancelOrder()">Hủy bàn</button>
            <button onclick="reserveTable()">Đặt bàn</button>
        </div>

        <div class="order-buttons">
            <button onclick="selectMenu()">Chọn thực đơn.....</button>
            <button onclick="processPayment()">Thanh toán.....</button>
            <button onclick="printBill()">In ấn.....</button>
        </div>

        <div id="viewTableModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('viewTableModal')">&times;</span>
                <h4 id="modalTableName">Xem thông tin bàn X</h4>

                <h5>Các món đã gọi:</h5>
                <div style="max-height: 150px; overflow-y: auto;"> <table id="modalOrderItems">
                    <thead>
                    <tr>
                        <th>Tên món</th>
                        <th>SL</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                </div>


                <h5>Đặt trước:</h5>
                <div id="modalReservationInfo" class="reservation-info">
                    Không có thông tin đặt trước.
                </div>

                <div class="modal-actions">
                    <button onclick="closeModal('viewTableModal')">Đóng</button>
                </div>
            </div>
        </div>

        <div id="moveTableModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('moveTableModal')">&times;</span>
                <h4 id="moveModalTitle">Chuyển bàn X</h4>

                <label for="destinationTableSelect">Chọn bàn cần chuyển đến:</label>
                <select id="destinationTableSelect">
                    <option value="">-- Chọn bàn trống --</option>
                </select>

                <div class="modal-actions">
                    <button onclick="confirmMoveTable()">Chuyển</button>
                    <button onclick="closeModal('moveTableModal')">Hủy</button>
                </div>
            </div>
        </div>

        <div id="mergeTableModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('mergeTableModal')">&times;</span>
                <h4 id="mergeModalTitle">Gộp bàn</h4>

                <div class="merge-container">
                    <div class="table-list-container">
                        <h5>Chọn các bàn cần gộp:</h5>
                        <div id="sourceTableChecklist">
                        </div>
                    </div>

                    <div class="merge-arrow">&gt;&gt;&gt;</div>

                    <div class="table-list-container">
                        <h5>Chọn bàn gộp đến:</h5>
                        <div id="destinationTableRadioList">
                        </div>
                    </div>
                </div>

                <div class="modal-actions" style="margin-top: 20px;">
                    <button onclick="confirmMergeTables()">Gộp</button>
                    <button onclick="closeModal('mergeTableModal')">Hủy</button>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    let selectedTableId = null;
    let selectedTableName = null;
    let allTablesData = []; // Lưu trữ dữ liệu tất cả bàn để lọc

    // Lưu dữ liệu bàn khi trang load (nếu cần lấy bàn trống từ dữ liệu đã có)
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.table-item').forEach(item => {
            const maban = item.getAttribute('data-maban');
            const tenban = item.getAttribute('data-tenban');
            const classes = item.classList; // Lấy danh sách class
            console.log(`Bàn ${tenban} - Classes:`, classes); // In ra classList

            // Logic lấy status
            let currentStatus = 'Unknown'; // Trạng thái mặc định
            if (classes.contains('status-trong')) { // Không dấu
                currentStatus = 'Trống'; // Giữ giá trị 'Trống' để lọc
            } else if (classes.contains('status-cokhach')) { // Không dấu, liền mạch
                currentStatus = 'Có khách';
            } else if (classes.contains('status-dattruoc')) { // Không dấu, liền mạch
                currentStatus = 'Đặt trước';
            }
            console.log(`Bàn ${tenban} - Determined Status:`, currentStatus); // In ra status đã xác định

            allTablesData.push({
                id: maban,
                name: tenban,
                status: currentStatus // Sử dụng status đã xác định
            });
        });
        console.log('--- Dữ liệu tất cả bàn:', allTablesData);
    });

    function selectTable(element) {
        // Bỏ chọn tất cả các bàn khác
        document.querySelectorAll('.table-item.selected').forEach(item => {
            item.classList.remove('selected');
        });

        // Chọn bàn mới
        element.classList.add('selected');
        selectedTableId = element.getAttribute('data-maban');
        selectedTableName = element.getAttribute('data-tenban'); // Lấy tên bàn
        console.log('Đã chọn bàn:', selectedTableId); // Hiển thị ID bàn đã chọn trên console
    }

    // Hàm để mở đóng MODAL
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Các hàm xử lý nút bấm (hiện tại chỉ log ra console)
    function viewTable() {
        if (!selectedTableId) {
            alert('Vui lòng chọn một bàn để xem.');
            return;
        }
        console.log('Xem bàn:', selectedTableId);

        // Gọi API backend để lấy chi tiết bàn
        fetch(`/sales/table/${selectedTableId}`) // Dùng fetch API
            .then(response => {
                if (!response.ok) {
                    throw new Error('Không thể lấy thông tin bàn.');
                }
                return response.json(); // Chuyển đổi phản hồi thành JSON
            })
            .then(data => {
                // Cập nhật nội dung modal với dữ liệu nhận được
                document.getElementById('modalTableName').textContent = `Xem thông tin ${selectedTableName}`; // Hiển thị tên bàn

                // Cập nhật bảng món ăn
                const orderTableBody = document.getElementById('modalOrderItems').querySelector('tbody');
                orderTableBody.innerHTML = ''; // Xóa dữ liệu cũ
                if (data.orderedItems && data.orderedItems.length > 0) {
                    data.orderedItems.forEach(item => {
                        const row = orderTableBody.insertRow();
                        row.insertCell(0).textContent = item.tenMon;
                        row.insertCell(1).textContent = item.soLuong;
                    });
                } else {
                    const row = orderTableBody.insertRow();
                    row.insertCell(0).textContent = 'Chưa gọi món';
                    row.insertCell(1).textContent = '-';
                }


                // Cập nhật thông tin đặt trước
                const reservationDiv = document.getElementById('modalReservationInfo');
                if (data.reservationInfo) {
                    // Định dạng lại ngày giờ nếu cần
                    const reservationTime = new Date(data.reservationInfo.ngayGioDat).toLocaleString('vi-VN');
                    reservationDiv.textContent = `${data.reservationInfo.tenKhachHang}, ${reservationTime}`;
                } else {
                    reservationDiv.textContent = 'Không có thông tin đặt trước.';
                }

                // Hiển thị modal
                openModal('viewTableModal');
            })
            .catch(error => {
                console.error('Lỗi khi lấy thông tin bàn:', error);
                alert('Đã xảy ra lỗi khi lấy thông tin bàn.');
            });
    }

    // --- HÀM ĐỂ MỞ MODAL CHUYỂN BÀN ---
    function openMoveTableModal() {
        if (!selectedTableId) {
            alert('Vui lòng chọn bàn muốn chuyển đi.');
            return;
        }
        // Kiểm tra bàn đang chọn có phải bàn trống không
        const selectedTableElement = document.querySelector(`.table-item[data-maban="${selectedTableId}"]`);
        if (selectedTableElement && selectedTableElement.classList.contains('status-trong')) {
            alert('Không thể chuyển từ bàn trống.');
            return;
        }


        console.log('Mở modal chuyển bàn:', selectedTableId);
        document.getElementById('moveModalTitle').textContent = `Chuyển ${selectedTableName}`;

        // Lấy danh sách bàn trống (trừ bàn đang chọn)
        const destinationSelect = document.getElementById('destinationTableSelect');
        destinationSelect.innerHTML = '<option value="">-- Chọn bàn trống --</option>'; // Reset dropdown

        // Lọc từ dữ liệu đã lưu hoặc gọi API mới /sales/available-tables
        const availableTables = allTablesData.filter(table => table.status === 'Trống');

        availableTables.forEach(table => {
            const option = document.createElement('option');
            option.value = table.id;
            option.textContent = table.name;
            destinationSelect.appendChild(option);
        });

        openModal('moveTableModal');
    }

    // --- HÀM ĐỂ XÁC NHẬN CHUYỂN BÀN ---
    function confirmMoveTable() {
        const destinationTableId = document.getElementById('destinationTableSelect').value;

        if (!destinationTableId) {
            alert('Vui lòng chọn bàn muốn chuyển đến.');
            return;
        }

        if (selectedTableId === destinationTableId) {
            alert('Bàn nguồn và bàn đích không thể giống nhau.');
            return;
        }

        console.log(`Xác nhận chuyển từ ${selectedTableId} sang ${destinationTableId}`);

        // --- LẤY CSRF TOKEN TỪ META TAGS ---
        const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

        // Gọi API backend để thực hiện chuyển bàn
        fetch('/sales/move-table', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [header]: token // Sử dụng tên header và giá trị token đã lấy
            },
            body: JSON.stringify({
                sourceTableId: selectedTableId,
                destinationTableId: destinationTableId
            })
        })
            .then(response => {
                if (!response.ok) {
                    // Xử lý lỗi từ server (ví dụ: hiển thị thông báo)
                    return response.text().then(text => { throw new Error(text || 'Chuyển bàn thất bại.') });
                }
                return response.json(); // Hoặc response.text() nếu backend không trả về JSON
            })
            .then(data => {
                console.log('Chuyển bàn thành công:', data);
                closeModal('moveTableModal');
                alert('Chuyển bàn thành công!');
                // Cập nhật lại giao diện lưới bàn (Cách đơn giản nhất là tải lại trang)
                window.location.reload();
                // Hoặc bạn có thể cập nhật DOM trực tiếp bằng JavaScript phức tạp hơn
            })
            .catch(error => {
                console.error('Lỗi khi chuyển bàn:', error);
                alert(`Lỗi: ${error.message}`);
            });
    }

    function splitTable() { console.log('Tách bàn:', selectedTableId); }

    // --- HÀM MỚI ĐỂ MỞ MODAL GỘP BÀN ---
    function openMergeTableModal() {
        // Lọc ra các bàn đang có khách hoặc đặt trước (nguồn)
        // Lọc ra các bàn đang có khách hoặc đặt trước (nguồn VÀ đích tiềm năng)
        const occupiedTables = allTablesData.filter(table => table.status !== 'Trống');
        // Lọc ra các bàn trống (đích tiềm năng)
        const emptyTables = allTablesData.filter(table => table.status === 'Trống');

        // Phải có ít nhất 1 bàn có khách/đặt trước để làm nguồn
        if (occupiedTables.length < 1) {
            alert('Cần ít nhất 1 bàn có khách/đặt trước để thực hiện gộp.');
            return;
        }

        console.log('Mở modal gộp bàn');
        document.getElementById('mergeModalTitle').textContent = `Gộp bàn`;

        const sourceChecklist = document.getElementById('sourceTableChecklist');
        const destinationRadioList = document.getElementById('destinationTableRadioList');
        sourceChecklist.innerHTML = ''; // Reset checklist
        destinationRadioList.innerHTML = ''; // Reset radio list

        // Tạo checkbox cho các bàn nguồn (có khách/đặt trước)
        occupiedTables.forEach(table => {
            const checkboxLabel = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'sourceTables';
            checkbox.value = table.id;
            // Tự động check bàn đang được chọn
            if (selectedTableId === table.id) {
                checkbox.checked = true;
            }
            checkboxLabel.appendChild(checkbox);
            checkboxLabel.appendChild(document.createTextNode(` ${table.name}`));
            sourceChecklist.appendChild(checkboxLabel);
        });

        // *** SỬA Ở ĐÂY: Tạo radio button cho TẤT CẢ bàn (cả trống và có khách) ***
        // Hoặc chỉ các bàn có khách/đặt trước + bàn trống
        // Hiện tại: Hiển thị TẤT CẢ bàn làm đích tiềm năng
        allTablesData.forEach((table, index) => { // Dùng allTablesData
            const radioLabel = document.createElement('label');
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'destinationTable';
            radio.value = table.id;
            // Tự động chọn bàn đang được selectedTableId làm đích (nếu có)
            if (selectedTableId === table.id && table.status !== 'Trống') {
                radio.checked = true;
            }
            // Hoặc chọn bàn đầu tiên
            // else if (index === 0) { radio.checked = true;}

            radioLabel.appendChild(radio);
            radioLabel.appendChild(document.createTextNode(` ${table.name} (${table.status})`)); // Hiển thị cả trạng thái
            destinationRadioList.appendChild(radioLabel);
        });

        openModal('mergeTableModal');
    }

    // --- HÀM MỚI ĐỂ XÁC NHẬN GỘP BÀN ---
    function confirmMergeTables() {
        const selectedSourceCheckboxes = document.querySelectorAll('#sourceTableChecklist input[name="sourceTables"]:checked');
        const selectedDestinationRadio = document.querySelector('#destinationTableRadioList input[name="destinationTable"]:checked');

        const sourceTableIds = Array.from(selectedSourceCheckboxes).map(cb => cb.value);
        const destinationTableId = selectedDestinationRadio ? selectedDestinationRadio.value : null;

        // Validation: Cần ít nhất 1 bàn nguồn
        if (sourceTableIds.length < 1) {
            alert('Vui lòng chọn ít nhất một bàn nguồn để gộp.');
            return;
        }
        if (!destinationTableId) {
            alert('Vui lòng chọn bàn đích để gộp đến.');
            return;
        }
        // Validation: Nếu chỉ chọn 1 bàn nguồn, bàn đích phải khác bàn nguồn đó
        if (sourceTableIds.length === 1 && sourceTableIds[0] === destinationTableId) {
            alert('Không thể gộp một bàn vào chính nó.');
            return;
        }


        console.log(`Xác nhận gộp bàn: ${sourceTableIds.join(', ')} vào bàn ${destinationTableId}`);

        // Gọi API backend
        fetch('/sales/merge-tables', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Thêm CSRF token
                [document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content')]: document.querySelector('meta[name="_csrf"]')?.getAttribute('content')
            },
            body: JSON.stringify({
                sourceTableIds: sourceTableIds,
                destinationTableId: destinationTableId
            })
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'Gộp bàn thất bại.') });
                }
                return response.json(); // Hoặc text()
            })
            .then(data => {
                console.log('Gộp bàn thành công:', data);
                closeModal('mergeTableModal');
                alert('Gộp bàn thành công!');
                window.location.reload(); // Tải lại trang
            })
            .catch(error => {
                console.error('Lỗi khi gộp bàn:', error);
                alert(`Lỗi: ${error.message}`);
            });
    }

    function cancelOrder() { console.log('Hủy bàn:', selectedTableId); }
    function reserveTable() { console.log('Đặt bàn:', selectedTableId); }
    function selectMenu() { console.log('Chọn thực đơn cho bàn:', selectedTableId); }
    function processPayment() { console.log('Thanh toán cho bàn:', selectedTableId); }
    function printBill() { console.log('In hóa đơn cho bàn:', selectedTableId); }

    // Đóng modal khi click ra ngoài
    window.onclick = function(event) {
        const viewModal = document.getElementById('viewTableModal');
        const moveModal = document.getElementById('moveTableModal');
        const mergeModal = document.getElementById('mergeTableModal');
        if (event.target == viewModal) closeModal('viewTableModal');
        if (event.target == moveModal) closeModal('moveTableModal');
        if (event.target == mergeModal) closeModal('mergeTableModal');
    }
</script>
</body>
</html>