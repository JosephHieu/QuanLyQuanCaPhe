<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Bán hàng</title>
    <link rel="stylesheet" th:href="@{/css/layout.css}" />
    <link rel="stylesheet" th:href="@{/css/sales.css}" />

    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>

</head>
<body>
<div th:insert="~{fragments/header :: header}"></div>

<div class="page-container">
    <div class="sidebar-wrapper">
        <div th:insert="~{fragments/sidebar :: sidebar}"></div>
        <div th:insert="~{fragments/footer :: footer}"></div>
    </div>

    <main class="main-content">
        <div class="breadcrumb">Quản lý bán hàng</div>

        <div class="table-grid" id="tableGrid">
            <div th:each="ban : ${dsBan}"
                 th:classappend="'table-item status-' + ${ban.tinhTrang == 'Trống' ? 'trong' : (ban.tinhTrang == 'Có khách' ? 'cokhach' : (ban.tinhTrang == 'Đặt trước' ? 'dattruoc' : 'unknown'))}"
                 th:attr="data-maban=${ban.maBan}, data-tenban=${ban.tenBan}"
                 onclick="selectTable(this)">

                <span th:text="${ban.tenBan}">Bàn 01</span>
                <small th:if="${ban.tinhTrang != 'Trống'}" th:text="'&lt;' + ${ban.tinhTrang} + '&gt;'">Trạng thái</small>
            </div>
        </div>

        <div class="action-buttons">
            <button onclick="viewTable()">Xem bàn</button>
            <button onclick="openMoveTableModal()">Chuyển bàn</button>
            <button onclick="openSplitTableModal()">Tách bàn</button>
            <button onclick="openMergeTableModal()">Gộp bàn</button>
            <button onclick="openCancelOrderModal()">Hủy bàn</button>
            <button onclick="openReserveTableModal()">Đặt bàn</button>
        </div>

        <div class="order-buttons">
            <button onclick="openSelectMenuModal()">Chọn thực đơn.....</button>
            <button onclick="processPayment()">Thanh toán.....</button>
            <button onclick="printBill()">In ấn.....</button>
        </div>

        <div id="viewTableModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('viewTableModal')">&times;</span>
                <h4 id="modalTableName">Xem thông tin bàn X</h4>

                <h5>Các món đã gọi:</h5>
                <div style="max-height: 150px; overflow-y: auto;"> <table id="modalOrderItems">
                    <thead>
                    <tr>
                        <th>Tên món</th>
                        <th>SL</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                </div>


                <h5>Đặt trước:</h5>
                <div id="modalReservationInfo" class="reservation-info">
                    Không có thông tin đặt trước.
                </div>

                <div class="modal-actions">
                    <button onclick="closeModal('viewTableModal')">Đóng</button>
                </div>
            </div>
        </div>

        <div id="moveTableModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('moveTableModal')">&times;</span>
                <h4 id="moveModalTitle">Chuyển bàn X</h4>

                <label for="destinationTableSelect">Chọn bàn cần chuyển đến:</label>
                <select id="destinationTableSelect">
                    <option value="">-- Chọn bàn trống --</option>
                </select>

                <div class="modal-actions">
                    <button onclick="confirmMoveTable()">Chuyển</button>
                    <button onclick="closeModal('moveTableModal')">Hủy</button>
                </div>
            </div>
        </div>

        <div id="mergeTableModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('mergeTableModal')">&times;</span>
                <h4 id="mergeModalTitle">Gộp bàn</h4>

                <div class="merge-container">
                    <div class="table-list-container">
                        <h5>Chọn các bàn cần gộp:</h5>
                        <div id="sourceTableChecklist">
                        </div>
                    </div>

                    <div class="merge-arrow">&gt;&gt;&gt;</div>

                    <div class="table-list-container">
                        <h5>Chọn bàn gộp đến:</h5>
                        <div id="destinationTableRadioList">
                        </div>
                    </div>
                </div>

                <div class="modal-actions" style="margin-top: 20px;">
                    <button onclick="confirmMergeTables()">Gộp</button>
                    <button onclick="closeModal('mergeTableModal')">Hủy</button>
                </div>
            </div>
        </div>

        <div id="splitTableModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('splitTableModal')">&times;</span>
                <h4 id="splitModalTitle">Tách bàn X</h4>

                <div class="split-container">
                    <div class="table-section">
                        <h5 id="sourceSplitTableName">Bàn nguồn: X</h5>
                        <div class="item-list-container">
                            <table id="sourceItemsTable">
                                <thead>
                                <tr>
                                    <th>Chọn</th>
                                    <th>Tên món</th>
                                    <th>SL Hiện tại</th>
                                    <th>SL Tách</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="split-arrow">&gt;&gt;&gt;</div>

                    <div class="table-section">
                        <label for="destinationTableSelectSplit">Chọn bàn cần tách đến (bàn trống):</label>
                        <select id="destinationTableSelectSplit">
                            <option value="">-- Chọn bàn trống --</option>
                        </select>
                        <h5>Các món sẽ tách sang:</h5>
                        <div class="item-list-container">
                            <table id="destinationItemsTable">
                                <thead>
                                <tr>
                                    <th>Tên món</th>
                                    <th>SL</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr><td colspan="2" style="text-align:center; font-style:italic;">(Chưa chọn món nào)</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="modal-actions" style="margin-top: 20px;">
                    <button onclick="confirmSplitTable()">Tách</button>
                    <button onclick="closeModal('splitTableModal')">Hủy</button>
                </div>
            </div>
        </div>

        <div id="cancelOrderModal" class="modal">
            <div class="modal-content">
                <h4>Xác nhận hủy bàn</h4>
                <p id="cancelConfirmText">Bạn có chắc muốn hủy bàn [Tên bàn] này hay không?</p>
                <div class="modal-actions">
                    <button onclick="confirmCancelOrder()">Có</button>
                    <button onclick="closeModal('cancelOrderModal')">Không</button>
                </div>
            </div>
        </div>

        <div id="selectMenuModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('selectMenuModal')">&times;</span>
                <h4 id="selectMenuTitle">Chọn/Sửa món cho bàn X</h4>

                <div id="menuItemList">
                    <table>
                        <thead>
                        <tr>
                            <th>Tên món</th>
                            <th>Giá</th>
                            <th>Số lượng</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr><td colspan="3">Đang tải...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="modal-actions">
                    <button onclick="confirmUpdateOrder()">Lưu</button> <button onclick="closeModal('selectMenuModal')">Hủy</button>
                </div>
            </div>
        </div>
    </main>

    <!--  Form đặt ban trước  -->
    <div id="reserveTableModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('reserveTableModal')">&times;</span>
            <h4 id="reserveModalTitle">Đặt bàn X</h4>

            <div class="form-grid">
                <label for="customerName">Khách hàng:</label>
                <input type="text" id="customerName" placeholder="Nhập tên khách hàng"/>

                <label for="customerPhone">SĐT:</label>
                <input type="text" id="customerPhone" placeholder="Nhập số điện thoại (tùy chọn)"/>

                <label for="reservationDate">Ngày:</label>
                <input type="date" id="reservationDate" />

                <label for="reservationTime">Giờ:</label>
                <input type="time" id="reservationTime" />
            </div>

            <div class="modal-actions">
                <button onclick="confirmReservation()">Đặt bàn</button>
                <button onclick="closeModal('reserveTableModal')">Hủy</button>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedTableId = null;
    let selectedTableName = null;
    let allTablesData = []; // Lưu trữ dữ liệu tất cả bàn để lọc
    let itemsToSplit = {}; // Lưu trữ món đang chọn để tách { maThucDon: { tenMon: '...', soLuongHienTai: X, soLuongTach: Y } }
    let currentOrderItems = {}; // Lưu trữ món hiện tại của bàn { maThucDon: soLuong }
    let fullMenu = [];

    // Lưu dữ liệu bàn khi trang load (nếu cần lấy bàn trống từ dữ liệu đã có)
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.table-item').forEach(item => {
            const maban = item.getAttribute('data-maban');
            const tenban = item.getAttribute('data-tenban');
            const classes = item.classList; // Lấy danh sách class
            console.log(`Bàn ${tenban} - Classes:`, classes); // In ra classList

            // Logic lấy status
            let currentStatus = 'Unknown'; // Trạng thái mặc định
            if (classes.contains('status-trong')) { // Không dấu
                currentStatus = 'Trống'; // Giữ giá trị 'Trống' để lọc
            } else if (classes.contains('status-cokhach')) { // Không dấu, liền mạch
                currentStatus = 'Có khách';
            } else if (classes.contains('status-dattruoc')) { // Không dấu, liền mạch
                currentStatus = 'Đặt trước';
            }
            console.log(`Bàn ${tenban} - Determined Status:`, currentStatus); // In ra status đã xác định

            allTablesData.push({
                id: maban,
                name: tenban,
                status: currentStatus // Sử dụng status đã xác định
            });

            fetch('/menu')
                .then(response => {
                    if (!response.ok) { // Thêm kiểm tra lỗi response
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    fullMenu = data;
                    console.log('--- Đã tải thực đơn thành công:', fullMenu); // Kiểm tra dữ liệu ở đây
                })
                .catch(error => {
                    // Lỗi xảy ra ở đây sẽ khiến fullMenu không có dữ liệu
                    console.error('--- Lỗi khi tải thực đơn:', error);
                    alert('Không thể tải thực đơn. Vui lòng thử lại.');
                });
        });
        console.log('--- Dữ liệu tất cả bàn:', allTablesData);
    });

    function selectTable(element) {
        // Bỏ chọn tất cả các bàn khác
        document.querySelectorAll('.table-item.selected').forEach(item => {
            item.classList.remove('selected');
        });

        // Chọn bàn mới
        element.classList.add('selected');
        selectedTableId = element.getAttribute('data-maban');
        selectedTableName = element.getAttribute('data-tenban'); // Lấy tên bàn
        console.log('Đã chọn bàn:', selectedTableId); // Hiển thị ID bàn đã chọn trên console
    }

    // Hàm để mở đóng MODAL
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Các hàm xử lý nút bấm (hiện tại chỉ log ra console)
    function viewTable() {
        if (!selectedTableId) {
            alert('Vui lòng chọn một bàn để xem.');
            return;
        }
        console.log('Xem bàn:', selectedTableId);

        // Gọi API backend để lấy chi tiết bàn
        fetch(`/sales/table/${selectedTableId}`) // Dùng fetch API
            .then(response => {
                if (!response.ok) {
                    throw new Error('Không thể lấy thông tin bàn.');
                }
                return response.json(); // Chuyển đổi phản hồi thành JSON
            })
            .then(data => {
                // Cập nhật nội dung modal với dữ liệu nhận được
                document.getElementById('modalTableName').textContent = `Xem thông tin ${selectedTableName}`; // Hiển thị tên bàn

                // Cập nhật bảng món ăn
                const orderTableBody = document.getElementById('modalOrderItems').querySelector('tbody');
                orderTableBody.innerHTML = ''; // Xóa dữ liệu cũ
                if (data.orderedItems && data.orderedItems.length > 0) {
                    data.orderedItems.forEach(item => {
                        const row = orderTableBody.insertRow();
                        row.insertCell(0).textContent = item.tenMon;
                        row.insertCell(1).textContent = item.soLuong;
                    });
                } else {
                    const row = orderTableBody.insertRow();
                    row.insertCell(0).textContent = 'Chưa gọi món';
                    row.insertCell(1).textContent = '-';
                }


                // Cập nhật thông tin đặt trước
                const reservationDiv = document.getElementById('modalReservationInfo');
                if (data.reservationInfo) {
                    // Định dạng lại ngày giờ nếu cần
                    const reservationTime = new Date(data.reservationInfo.ngayGioDat).toLocaleString('vi-VN');
                    reservationDiv.textContent = `${data.reservationInfo.tenKhachHang}, ${reservationTime}`;
                } else {
                    reservationDiv.textContent = 'Không có thông tin đặt trước.';
                }

                // Hiển thị modal
                openModal('viewTableModal');
            })
            .catch(error => {
                console.error('Lỗi khi lấy thông tin bàn:', error);
                alert('Đã xảy ra lỗi khi lấy thông tin bàn.');
            });
    }

    // --- HÀM ĐỂ MỞ MODAL CHUYỂN BÀN ---
    function openMoveTableModal() {
        if (!selectedTableId) {
            alert('Vui lòng chọn bàn muốn chuyển đi.');
            return;
        }
        // Kiểm tra bàn đang chọn có phải bàn trống không
        const selectedTableElement = document.querySelector(`.table-item[data-maban="${selectedTableId}"]`);
        if (selectedTableElement && selectedTableElement.classList.contains('status-trong')) {
            alert('Không thể chuyển từ bàn trống.');
            return;
        }


        console.log('Mở modal chuyển bàn:', selectedTableId);
        document.getElementById('moveModalTitle').textContent = `Chuyển ${selectedTableName}`;

        // Lấy danh sách bàn trống (trừ bàn đang chọn)
        const destinationSelect = document.getElementById('destinationTableSelect');
        destinationSelect.innerHTML = '<option value="">-- Chọn bàn trống --</option>'; // Reset dropdown

        // Lọc từ dữ liệu đã lưu hoặc gọi API mới /sales/available-tables
        const availableTables = allTablesData.filter(table => table.status === 'Trống');

        availableTables.forEach(table => {
            const option = document.createElement('option');
            option.value = table.id;
            option.textContent = table.name;
            destinationSelect.appendChild(option);
        });

        openModal('moveTableModal');
    }

    // --- HÀM ĐỂ XÁC NHẬN CHUYỂN BÀN ---
    function confirmMoveTable() {
        const destinationTableId = document.getElementById('destinationTableSelect').value;

        if (!destinationTableId) {
            alert('Vui lòng chọn bàn muốn chuyển đến.');
            return;
        }

        if (selectedTableId === destinationTableId) {
            alert('Bàn nguồn và bàn đích không thể giống nhau.');
            return;
        }

        console.log(`Xác nhận chuyển từ ${selectedTableId} sang ${destinationTableId}`);

        // --- LẤY CSRF TOKEN TỪ META TAGS ---
        const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

        // Gọi API backend để thực hiện chuyển bàn
        fetch('/sales/move-table', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [header]: token // Sử dụng tên header và giá trị token đã lấy
            },
            body: JSON.stringify({
                sourceTableId: selectedTableId,
                destinationTableId: destinationTableId
            })
        })
            .then(response => {
                if (!response.ok) {
                    // Xử lý lỗi từ server (ví dụ: hiển thị thông báo)
                    return response.text().then(text => { throw new Error(text || 'Chuyển bàn thất bại.') });
                }
                return response.json(); // Hoặc response.text() nếu backend không trả về JSON
            })
            .then(data => {
                console.log('Chuyển bàn thành công:', data);
                closeModal('moveTableModal');
                alert('Chuyển bàn thành công!');
                // Cập nhật lại giao diện lưới bàn (Cách đơn giản nhất là tải lại trang)
                window.location.reload();
                // Hoặc bạn có thể cập nhật DOM trực tiếp bằng JavaScript phức tạp hơn
            })
            .catch(error => {
                console.error('Lỗi khi chuyển bàn:', error);
                alert(`Lỗi: ${error.message}`);
            });
    }

    function splitTable() { console.log('Tách bàn:', selectedTableId); }

    // --- HÀM MỚI ĐỂ MỞ MODAL GỘP BÀN ---
    function openMergeTableModal() {
        // Lọc ra các bàn đang có khách hoặc đặt trước (nguồn)
        // Lọc ra các bàn đang có khách hoặc đặt trước (nguồn VÀ đích tiềm năng)
        const occupiedTables = allTablesData.filter(table => table.status !== 'Trống');
        // Lọc ra các bàn trống (đích tiềm năng)
        const emptyTables = allTablesData.filter(table => table.status === 'Trống');

        // Phải có ít nhất 1 bàn có khách/đặt trước để làm nguồn
        if (occupiedTables.length < 1) {
            alert('Cần ít nhất 1 bàn có khách/đặt trước để thực hiện gộp.');
            return;
        }

        console.log('Mở modal gộp bàn');
        document.getElementById('mergeModalTitle').textContent = `Gộp bàn`;

        const sourceChecklist = document.getElementById('sourceTableChecklist');
        const destinationRadioList = document.getElementById('destinationTableRadioList');
        sourceChecklist.innerHTML = ''; // Reset checklist
        destinationRadioList.innerHTML = ''; // Reset radio list

        // Tạo checkbox cho các bàn nguồn (có khách/đặt trước)
        occupiedTables.forEach(table => {
            const checkboxLabel = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'sourceTables';
            checkbox.value = table.id;
            // Tự động check bàn đang được chọn
            if (selectedTableId === table.id) {
                checkbox.checked = true;
            }
            checkboxLabel.appendChild(checkbox);
            checkboxLabel.appendChild(document.createTextNode(` ${table.name}`));
            sourceChecklist.appendChild(checkboxLabel);
        });

        // *** SỬA Ở ĐÂY: Tạo radio button cho TẤT CẢ bàn (cả trống và có khách) ***
        // Hoặc chỉ các bàn có khách/đặt trước + bàn trống
        // Hiện tại: Hiển thị TẤT CẢ bàn làm đích tiềm năng
        allTablesData.forEach((table, index) => { // Dùng allTablesData
            const radioLabel = document.createElement('label');
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'destinationTable';
            radio.value = table.id;
            // Tự động chọn bàn đang được selectedTableId làm đích (nếu có)
            if (selectedTableId === table.id && table.status !== 'Trống') {
                radio.checked = true;
            }
            // Hoặc chọn bàn đầu tiên
            // else if (index === 0) { radio.checked = true;}

            radioLabel.appendChild(radio);
            radioLabel.appendChild(document.createTextNode(` ${table.name} (${table.status})`)); // Hiển thị cả trạng thái
            destinationRadioList.appendChild(radioLabel);
        });

        openModal('mergeTableModal');
    }

    // --- HÀM MỚI ĐỂ XÁC NHẬN GỘP BÀN ---
    function confirmMergeTables() {
        const selectedSourceCheckboxes = document.querySelectorAll('#sourceTableChecklist input[name="sourceTables"]:checked');
        const selectedDestinationRadio = document.querySelector('#destinationTableRadioList input[name="destinationTable"]:checked');

        const sourceTableIds = Array.from(selectedSourceCheckboxes).map(cb => cb.value);
        const destinationTableId = selectedDestinationRadio ? selectedDestinationRadio.value : null;

        // Validation: Cần ít nhất 1 bàn nguồn
        if (sourceTableIds.length < 1) {
            alert('Vui lòng chọn ít nhất một bàn nguồn để gộp.');
            return;
        }
        if (!destinationTableId) {
            alert('Vui lòng chọn bàn đích để gộp đến.');
            return;
        }
        // Validation: Nếu chỉ chọn 1 bàn nguồn, bàn đích phải khác bàn nguồn đó
        if (sourceTableIds.length === 1 && sourceTableIds[0] === destinationTableId) {
            alert('Không thể gộp một bàn vào chính nó.');
            return;
        }


        console.log(`Xác nhận gộp bàn: ${sourceTableIds.join(', ')} vào bàn ${destinationTableId}`);

        // Gọi API backend
        fetch('/sales/merge-tables', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Thêm CSRF token
                [document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content')]: document.querySelector('meta[name="_csrf"]')?.getAttribute('content')
            },
            body: JSON.stringify({
                sourceTableIds: sourceTableIds,
                destinationTableId: destinationTableId
            })
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'Gộp bàn thất bại.') });
                }
                return response.json(); // Hoặc text()
            })
            .then(data => {
                console.log('Gộp bàn thành công:', data);
                closeModal('mergeTableModal');
                alert('Gộp bàn thành công!');
                window.location.reload(); // Tải lại trang
            })
            .catch(error => {
                console.error('Lỗi khi gộp bàn:', error);
                alert(`Lỗi: ${error.message}`);
            });
    }

    // --- HÀM MỚI ĐỂ MỞ MODAL TÁCH BÀN ---
    function openSplitTableModal() {
        if (!selectedTableId) {
            alert('Vui lòng chọn bàn muốn tách.');
            return;
        }
        // Kiểm tra bàn đang chọn có trống không
        const selectedTableElement = document.querySelector(`.table-item[data-maban="${selectedTableId}"]`);
        if (selectedTableElement && selectedTableElement.classList.contains('status-trong')) {
            alert('Không thể tách từ bàn trống.');
            return;
        }
        // Lấy danh sách bàn trống
        const emptyTables = allTablesData.filter(table => table.status === 'Trống');
        if (emptyTables.length < 1) {
            alert('Không có bàn trống nào để tách đến.');
            return;
        }


        console.log('Mở modal tách bàn:', selectedTableId);
        document.getElementById('splitModalTitle').textContent = `Tách ${selectedTableName}`;
        document.getElementById('sourceSplitTableName').textContent = `Bàn nguồn: ${selectedTableName}`;
        itemsToSplit = {}; // Reset

        const destSelect = document.getElementById('destinationTableSelectSplit');
        destSelect.innerHTML = '<option value="">-- Chọn bàn trống --</option>'; // Reset dropdown
        emptyTables.forEach(table => { // Populate bàn trống
            const option = document.createElement('option');
            option.value = table.id;
            option.textContent = table.name;
            destSelect.appendChild(option);
        });

        const sourceTableBody = document.getElementById('sourceItemsTable').querySelector('tbody');
        sourceTableBody.innerHTML = '<tr><td colspan="4">Đang tải...</td></tr>'; // Loading
        updateDestinationItemsTable(); // Hiển thị rỗng ban đầu

        // Gọi API lấy các món của bàn nguồn
        fetch(`/sales/table/${selectedTableId}`)
            .then(response => response.ok ? response.json() : Promise.reject('Lỗi lấy món'))
            .then(data => {
                sourceTableBody.innerHTML = ''; // Xóa loading
                if (data.orderedItems && data.orderedItems.length > 0) {
                    data.orderedItems.forEach(item => {
                        const row = sourceTableBody.insertRow();
                        const checkCell = row.insertCell(0);
                        const nameCell = row.insertCell(1);
                        const currentQtyCell = row.insertCell(2);
                        const splitQtyCell = row.insertCell(3);

                        // Checkbox
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.dataset.maThucDon = item.maThucDon; // Dùng mã món thực đơn nếu DTO trả về
                        // Giả sử DTO trả về maChiTietHoaDon, tenMon, soLuong
                        // checkbox.dataset.maChiTiet = item.maChiTietHoaDon; // Lưu ID chi tiết nếu cần
                        checkbox.dataset.tenMon = item.tenMon;
                        checkbox.dataset.currentQty = item.soLuong;
                        checkbox.onchange = handleSplitSelectionChange;
                        checkCell.appendChild(checkbox);

                        nameCell.textContent = item.tenMon;
                        currentQtyCell.textContent = item.soLuong;

                        // Input số lượng tách
                        const splitInput = document.createElement('input');
                        splitInput.type = 'number';
                        splitInput.min = '0';
                        splitInput.max = item.soLuong; // Tối đa là số lượng hiện có
                        splitInput.value = '0';
                        splitInput.dataset.maThucDon = item.maThucDon; // Dùng mã món thực đơn
                        // splitInput.dataset.maChiTiet = item.maChiTietHoaDon;
                        splitInput.disabled = true; // Chỉ bật khi checkbox được chọn
                        splitInput.onchange = handleSplitQuantityChange;
                        splitQtyCell.appendChild(splitInput);
                    });
                } else {
                    sourceTableBody.innerHTML = '<tr><td colspan="4">Bàn chưa gọi món.</td></tr>';
                }
                openModal('splitTableModal');
            })
            .catch(error => {
                console.error('Lỗi khi lấy món của bàn nguồn:', error);
                alert('Không thể lấy danh sách món của bàn này.');
            });
    }

    // --- HÀM XỬ LÝ KHI CHECKBOX THAY ĐỔI ---
    function handleSplitSelectionChange(event) {
        const checkbox = event.target;
        const row = checkbox.closest('tr');
        const splitInput = row.querySelector('input[type="number"]');
        const maThucDon = checkbox.dataset.maThucDon;
        const tenMon = checkbox.dataset.tenMon;
        const currentQty = parseInt(checkbox.dataset.currentQty);

        if (checkbox.checked) {
            splitInput.disabled = false;
            splitInput.value = '1'; // Mặc định tách 1
            itemsToSplit[maThucDon] = { tenMon: tenMon, soLuongHienTai: currentQty, soLuongTach: 1 };
        } else {
            splitInput.disabled = true;
            splitInput.value = '0';
            delete itemsToSplit[maThucDon];
        }
        updateDestinationItemsTable();
    }

    // --- HÀM XỬ LÝ KHI SỐ LƯỢNG TÁCH THAY ĐỔI ---
    function handleSplitQuantityChange(event) {
        const input = event.target;
        const maThucDon = input.dataset.maThucDon;
        let soLuongTach = parseInt(input.value) || 0;
        const maxQty = parseInt(input.max);

        // Validate số lượng
        if (soLuongTach < 0) soLuongTach = 0;
        if (soLuongTach > maxQty) soLuongTach = maxQty;
        input.value = soLuongTach; // Cập nhật lại input nếu giá trị không hợp lệ

        if (itemsToSplit[maThucDon]) { // Chỉ cập nhật nếu món đã được chọn
            itemsToSplit[maThucDon].soLuongTach = soLuongTach;
            if (soLuongTach === 0) { // Nếu giảm về 0 thì bỏ chọn luôn
                const checkbox = input.closest('tr').querySelector('input[type="checkbox"]');
                checkbox.checked = false;
                input.disabled = true;
                delete itemsToSplit[maThucDon];
            }
        }
        updateDestinationItemsTable();
    }

    // --- HÀM CẬP NHẬT BẢNG MÓN ĐÍCH ---
    function updateDestinationItemsTable() {
        const destTableBody = document.getElementById('destinationItemsTable').querySelector('tbody');
        destTableBody.innerHTML = ''; // Xóa cũ
        let hasItems = false;
        for (const maThucDon in itemsToSplit) {
            const item = itemsToSplit[maThucDon];
            if (item.soLuongTach > 0) {
                hasItems = true;
                const row = destTableBody.insertRow();
                row.insertCell(0).textContent = item.tenMon;
                row.insertCell(1).textContent = item.soLuongTach;
            }
        }
        if (!hasItems) {
            destTableBody.innerHTML = '<tr><td colspan="2" style="text-align:center; font-style:italic;">(Chưa chọn món nào)</td></tr>';
        }
    }

    // --- HÀM XÁC NHẬN TÁCH BÀN ---
    function confirmSplitTable() {
        const destinationTableId = document.getElementById('destinationTableSelectSplit').value;
        const itemsToMove = [];

        for (const maThucDon in itemsToSplit) {
            const item = itemsToSplit[maThucDon];
            if (item.soLuongTach > 0) {
                itemsToMove.push({ maThucDon: maThucDon, soLuong: item.soLuongTach });
            }
        }

        if (!destinationTableId) {
            alert('Vui lòng chọn bàn trống để tách đến.');
            return;
        }
        if (itemsToMove.length === 0) {
            alert('Vui lòng chọn ít nhất một món và số lượng > 0 để tách.');
            return;
        }


        console.log(`Xác nhận tách bàn ${selectedTableId} sang ${destinationTableId} với các món:`, itemsToMove);

        // Gọi API backend
        fetch('/sales/split-table', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content')]: document.querySelector('meta[name="_csrf"]')?.getAttribute('content')
            },
            body: JSON.stringify({
                sourceTableId: selectedTableId,
                destinationTableId: destinationTableId,
                items: itemsToMove // Gửi dạng { sourceTableId: "id1", destinationTableId: "id2", items: [ {maThucDon: "idm1", soLuong: 1}, ...] }
            })
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'Tách bàn thất bại.') });
                }
                return response.json(); // Hoặc text()
            })
            .then(data => {
                console.log('Tách bàn thành công:', data);
                closeModal('splitTableModal');
                alert('Tách bàn thành công!');
                window.location.reload(); // Tải lại trang
            })
            .catch(error => {
                console.error('Lỗi khi tách bàn:', error);
                alert(`Lỗi: ${error.message}`);
            });
    }

    // --- HÀM MỚI ĐỂ MỞ MODAL HỦY BÀN ---
    function openCancelOrderModal() {
        if (!selectedTableId) {
            alert('Vui lòng chọn bàn muốn hủy.');
            return;
        }
        // Kiểm tra xem bàn có trống không
        const selectedTableElement = document.querySelector(`.table-item[data-maban="${selectedTableId}"]`);
        if (selectedTableElement && selectedTableElement.classList.contains('status-trong')) {
            alert('Bàn này đang trống, không thể hủy.');
            return;
        }

        console.log('Mở modal hủy bàn:', selectedTableId);
        document.getElementById('cancelConfirmText').textContent = `Bạn có chắc muốn hủy ${selectedTableName} này hay không?`;
        openModal('cancelOrderModal');
    }

    // --- HÀM MỚI ĐỂ XÁC NHẬN HỦY BÀN ---
    function confirmCancelOrder() {
        if (!selectedTableId) return; // Kiểm tra lại

        console.log('Xác nhận hủy bàn:', selectedTableId);

        // Gọi API backend
        fetch('/sales/cancel-order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content')]: document.querySelector('meta[name="_csrf"]')?.getAttribute('content')
            },
            body: JSON.stringify({ maBan: selectedTableId }) // Gửi ID bàn cần hủy
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'Hủy bàn thất bại.') });
                }
                // Không cần parse JSON nếu backend chỉ trả về text hoặc 200 OK rỗng
                return response.text(); // Hoặc response.json() nếu backend trả về JSON
            })
            .then(data => {
                console.log('Hủy bàn thành công:', data);
                closeModal('cancelOrderModal');
                alert('Hủy bàn thành công!');
                window.location.reload(); // Tải lại trang
            })
            .catch(error => {
                console.error('Lỗi khi hủy bàn:', error);
                alert(`Lỗi: ${error.message}`);
            });
    }

    // --- HÀM MỚI ĐỂ MỞ MODAL ĐẶT BÀN ---
    function openReserveTableModal() {
        if (!selectedTableId) {
            alert('Vui lòng chọn bàn muốn đặt.');
            return;
        }
        // Kiểm tra xem bàn có trống không
        const selectedTableElement = document.querySelector(`.table-item[data-maban="${selectedTableId}"]`);
        if (selectedTableElement && !selectedTableElement.classList.contains('status-trong')) {
            alert('Chỉ có thể đặt bàn trống.');
            return;
        }

        console.log('Mở modal đặt bàn:', selectedTableId);
        document.getElementById('reserveModalTitle').textContent = `Đặt ${selectedTableName}`;

        // Reset form
        document.getElementById('customerName').value = '';
        document.getElementById('customerPhone').value = '';

        // Set ngày giờ hiện tại làm mặc định
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0'); // Tháng từ 0-11
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');

        document.getElementById('reservationDate').value = `${year}-${month}-${day}`;
        document.getElementById('reservationTime').value = `${hours}:${minutes}`;


        openModal('reserveTableModal');
    }

    // --- HÀM MỚI ĐỂ XÁC NHẬN ĐẶT BÀN ---
    function confirmReservation() {
        const customerName = document.getElementById('customerName').value.trim();
        const customerPhone = document.getElementById('customerPhone').value.trim();
        const reservationDate = document.getElementById('reservationDate').value;
        const reservationTime = document.getElementById('reservationTime').value;

        if (!customerName) {
            alert('Vui lòng nhập tên khách hàng.');
            return;
        }
        if (!reservationDate || !reservationTime) {
            alert('Vui lòng chọn ngày và giờ đặt.');
            return;
        }

        // Kết hợp ngày và giờ thành LocalDateTime string (ISO 8601 format)
        const reservationDateTime = `${reservationDate}T${reservationTime}:00`;

        console.log(`Xác nhận đặt bàn ${selectedTableId} cho ${customerName} lúc ${reservationDateTime}`);

        // Gọi API backend
        fetch('/sales/reserve-table', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content')]: document.querySelector('meta[name="_csrf"]')?.getAttribute('content')
            },
            body: JSON.stringify({
                maBan: selectedTableId,
                tenKhachHang: customerName,
                sdtKhachHang: customerPhone,
                ngayGioDat: reservationDateTime // Gửi dạng ISO string
            })
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'Đặt bàn thất bại.') });
                }
                return response.json(); // Hoặc text()
            })
            .then(data => {
                console.log('Đặt bàn thành công:', data);
                closeModal('reserveTableModal');
                alert('Đặt bàn thành công!');
                window.location.reload(); // Tải lại trang
            })
            .catch(error => {
                console.error('Lỗi khi đặt bàn:', error);
                alert(`Lỗi: ${error.message}`);
            });
    }

    // --- CẬP NHẬT HÀM MỞ MODAL CHỌN MÓN ---
    function openSelectMenuModal() {
        if (!selectedTableId) {
            alert('Vui lòng chọn một bàn.');
            return;
        }


        if (!fullMenu || fullMenu.length === 0) {
            console.error('Thực đơn chưa được tải hoặc bị rỗng.');
            alert('Chưa tải được thực đơn. Vui lòng đợi hoặc thử tải lại trang.');
            return; // Dừng lại nếu chưa có menu
        }

        // Không cho chọn món cho bàn trống (trừ khi muốn bắt đầu order mới - logic này đã có)
        const selectedTableElement = document.querySelector(`.table-item[data-maban="${selectedTableId}"]`);
        if (selectedTableElement && selectedTableElement.classList.contains('status-trong')) {
            alert('Không thể chọn thực đơn cho bàn trống. Vui lòng đặt bàn trước hoặc chọn bàn đang có khách.');
            return; // Dừng hàm nếu bàn trống
        }

        console.log('Mở modal chọn/sửa món cho bàn:', selectedTableId);
        document.getElementById('selectMenuTitle').textContent = `Chọn/Sửa món cho ${selectedTableName}`;
        currentOrderItems = {}; // Reset món hiện tại

        const menuTableBody = document.getElementById('menuItemList').querySelector('tbody');
        menuTableBody.innerHTML = '<tr><td colspan="3">Đang tải danh sách món và đơn hàng hiện tại...</td></tr>';

        // Bước 1: Gọi API lấy đơn hàng hiện tại của bàn
        fetch(`/sales/table/${selectedTableId}`)
            .then(response => response.ok ? response.json() : Promise.reject('Lỗi lấy đơn hàng hiện tại'))
            .then(tableData => {
                // Lưu lại các món đã gọi
                if (tableData.orderedItems) {
                    tableData.orderedItems.forEach(item => {
                        currentOrderItems[item.maThucDon] = item.soLuong;
                    });
                }
                console.log('Món hiện tại của bàn:', currentOrderItems);

                // Bước 2: Hiển thị toàn bộ thực đơn và điền số lượng cũ
                menuTableBody.innerHTML = ''; // Xóa loading
                if (!fullMenu || fullMenu.length === 0) {
                    menuTableBody.innerHTML = '<tr><td colspan="3">Không tải được thực đơn.</td></tr>';
                    return;
                }

                fullMenu.forEach(item => {
                    const row = menuTableBody.insertRow();
                    row.insertCell(0).textContent = item.tenMon;
                    row.insertCell(1).textContent = item.giaTienHienTai.toLocaleString('vi-VN') + ' đ';
                    const quantityCell = row.insertCell(2);
                    const quantityInput = document.createElement('input');
                    quantityInput.type = 'number';
                    quantityInput.min = '0';
                    // Điền số lượng hiện tại nếu có, nếu không thì là 0
                    quantityInput.value = currentOrderItems[item.maThucDon] || '0';
                    quantityInput.dataset.maThucDon = item.maThucDon;
                    // quantityInput.onchange = updateSelectedItems; // Không cần update list riêng nữa
                    quantityCell.appendChild(quantityInput);
                });
                openModal('selectMenuModal');
            })
            .catch(error => {
                console.error('Lỗi khi mở modal chọn món:', error);
                alert('Không thể tải thông tin món ăn hoặc đơn hàng hiện tại.');
            });
    }

    // --- HÀM MỚI ĐỂ XÁC NHẬN CẬP NHẬT ORDER ---
    function confirmUpdateOrder() {
        const itemsToSend = [];
        const inputs = document.getElementById('menuItemList').querySelectorAll('input[type="number"]');

        // Lấy tất cả món và số lượng từ các ô input
        inputs.forEach(input => {
            const maThucDon = input.dataset.maThucDon;
            const soLuong = parseInt(input.value) || 0;
            // Chỉ gửi những món có số lượng >= 0 (bao gồm cả 0 để xóa)
            // Hoặc chỉ gửi món có số lượng > 0 tùy logic backend
            // Hiện tại: Gửi tất cả món có input >= 0
            if (soLuong >= 0 && maThucDon) {
                itemsToSend.push({ maThucDon: maThucDon, soLuong: soLuong });
            }

        });

        // Có thể bỏ qua kiểm tra này nếu cho phép lưu order rỗng (để hủy bàn)
        // if (itemsToSend.every(item => item.soLuong === 0)) {
        //     if (!confirm('Bạn chưa chọn món nào hoặc đặt số lượng về 0. Bạn muốn xóa hết món trên bàn này?')) {
        //         return;
        //     }
        // }


        console.log('Xác nhận cập nhật order:', itemsToSend, 'cho bàn:', selectedTableId);

        // Gọi API backend (tạo endpoint mới)
        fetch('/sales/update-order', { // Dùng endpoint mới
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content')]: document.querySelector('meta[name="_csrf"]')?.getAttribute('content')
            },
            body: JSON.stringify({
                maBan: selectedTableId,
                items: itemsToSend // Gửi toàn bộ danh sách mới { maBan: "id", items: [ {maThucDon: "id1", soLuong: 2}, {maThucDon: "id2", soLuong: 0}, ... ] }
            })
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'Cập nhật đơn hàng thất bại.') });
                }
                return response.json(); // Hoặc text()
            })
            .then(data => {
                console.log('Cập nhật đơn hàng thành công:', data);
                closeModal('selectMenuModal');
                alert('Cập nhật đơn hàng thành công!');
                window.location.reload(); // Tải lại trang
            })
            .catch(error => {
                console.error('Lỗi khi cập nhật đơn hàng:', error);
                alert(`Lỗi: ${error.message}`);
            });
    }

    function processPayment() { console.log('Thanh toán cho bàn:', selectedTableId); }
    function printBill() { console.log('In hóa đơn cho bàn:', selectedTableId); }

    // Đóng modal khi click ra ngoài
    window.onclick = function(event) {
        const viewModal = document.getElementById('viewTableModal');
        const moveModal = document.getElementById('moveTableModal');
        const mergeModal = document.getElementById('mergeTableModal');
        const splitModal = document.getElementById('splitTableModal'); // Thêm
        const cancelModal = document.getElementById('cancelOrderModal'); // Thêm
        const reserveModal = document.getElementById('reserveTableModal'); // Thêm
        const selectMenuModal = document.getElementById('selectMenuModal');

        if (event.target == viewModal) closeModal('viewTableModal');
        if (event.target == moveModal) closeModal('moveTableModal');
        if (event.target == mergeModal) closeModal('mergeTableModal');
        if (event.target == splitModal) closeModal('splitTableModal'); // Thêm
        if (event.target == cancelModal) closeModal('cancelOrderModal'); // Thêm
        if (event.target == reserveModal) closeModal('reserveTableModal'); // Thêm
        if (event.target == selectMenuModal) closeModal('selectMenuModal');
    }
</script>
</body>
</html>